{% extends "base.html" %}
{% load static %}

{% block title %}Tableau de bord - EcoWatch{% endblock %}
{% block page_title %}Tableau de bord{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'monitoring/css/dashboard.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #map {
        height: 500px;
        border-radius: 0.75rem;
    }

    #chart-container {
        height: 300px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .iqa-card {
        grid-column: span 2;
        background: var(--primary);
        color: white;
    }

    .iqa-card .stat-value {
        color: white;
        font-size: 3rem;
    }

    .iqa-card .stat-label {
        color: rgba(255, 255, 255, 0.9);
    }

    #station-info {
        margin-bottom: 1rem;
    }

    #station-info h4 {
        margin-bottom: 0.5rem;
        color: var(--dark);
    }

    #station-info p {
        color: var(--gray);
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="grid-4 mb-4">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-map-marker-alt"></i>
        </div>
        <div class="stat-value" id="total-stations">-</div>
        <div class="stat-label">Stations Actives</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: #dbeafe; color: #3b82f6;">
            <i class="fas fa-wind"></i>
        </div>
        <div class="stat-value" style="color: #3b82f6;" id="avg-iqa">-</div>
        <div class="stat-label">IQA Moyen</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: #fef3c7; color: #f59e0b;">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-value" style="color: #f59e0b;">0</div>
        <div class="stat-label">Alertes Actives</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: #fee2e2; color: #ef4444;">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-value" style="color: #ef4444;" id="readings-today">-</div>
        <div class="stat-label">Relevés Aujourd'hui</div>
    </div>
</div>

<!-- Map Card -->
<div class="card mb-4 map-visual-container">
    <div class="card-header">
        <h3 class="card-title">Carte de la Qualité de l'Air</h3>
        <div style="display: flex; gap: 0.75rem; font-size: 0.85rem;">
            <span style="display:flex; align-items:center; gap:5px;">
                <span style="width:12px; height:12px; background:#10b981; border-radius:50%;"></span>
                Bon
            </span>
            <span style="display:flex; align-items:center; gap:5px;">
                <span style="width:12px; height:12px; background:#f59e0b; border-radius:50%;"></span>
                Modéré
            </span>
            <span style="display:flex; align-items:center; gap:5px;">
                <span style="width:12px; height:12px; background:#ef4444; border-radius:50%;"></span>
                Mauvais
            </span>
        </div>
    </div>
    <div class="card-body">
        <div id="map" style="height: 450px;"></div>
    </div>
</div>

<!-- Station Details & Chart -->
<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Détails de la Station</h3>
            <button id="export-btn" class="btn btn-primary btn-sm" style="display: none;">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>
        <div class="card-body">
            <div id="station-info">
                <p style="color: var(--gray);">Sélectionnez une station sur la carte pour voir les détails.</p>
            </div>
            <div class="stats-grid" id="current-stats" style="display: none;">
                <div class="stat-card iqa-card" id="card-iqa">
                    <div class="stat-label">Indice IQA</div>
                    <div class="stat-value" id="val-iqa">-</div>
                    <div id="iqa-status" style="font-size: 0.9rem; font-weight: 600;">Chargement...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="val-pm25">-</div>
                    <div class="stat-label">PM2.5 (µg/m³)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="val-co">-</div>
                    <div class="stat-label">CO (ppm)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="val-temp">-</div>
                    <div class="stat-label">Temp °C</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="val-hum">-</div>
                    <div class="stat-label">Humidité %</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Évolution Temporelle</h3>
        </div>
        <div class="card-body">
            <div id="chart-container">
                <canvas id="airChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Initialize map
    const map = L.map('map').setView([10.5, -11.0], 7);

    const standard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    });

    standard.addTo(map);
    L.control.layers({ "Standard": standard, "Satellite": satellite }).addTo(map);

    let airChart;
    let currentReadings = [];

    function getIQAColor(iqa) {
        if (iqa <= 50) return "#10b981";
        if (iqa <= 100) return "#f59e0b";
        return "#ef4444";
    }

    function createCustomIcon(iqa) {
        const color = getIQAColor(iqa);
        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color:${color}; border: 3px solid white; width:16px; height:16px; border-radius:50%; box-shadow: 0 0 10px rgba(0,0,0,0.2);"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });
    }

    async function fetchStations() {
        try {
            const response = await fetch('/api/stations/');
            const stations = await response.json();
            
            document.getElementById('total-stations').innerText = stations.length;
            let totalIQA = 0;
            let totalReadings = 0;

            for (const station of stations) {
                const rResp = await fetch(`/api/readings/?station=${station.id}`);
                const readings = await rResp.json();
                const iqa = readings.length > 0 ? readings[0].iqa : 0;
                
                if (readings.length > 0) {
                    totalIQA += iqa;
                    totalReadings += readings.length;
                }

                const marker = L.marker([station.latitude, station.longitude], {
                    icon: createCustomIcon(iqa)
                }).addTo(map);

                marker.bindPopup(`<b>${station.name}</b><br>IQA actuel: ${iqa}`);
                marker.on('click', () => updateStationDetails(station, readings));
            }
            
            if (stations.length > 0) {
                document.getElementById('avg-iqa').innerText = Math.round(totalIQA / stations.length);
            }
            document.getElementById('readings-today').innerText = totalReadings;
            
        } catch (error) {
            console.error('Error fetching stations:', error);
        }
    }

    async function updateStationDetails(station, readings) {
        currentReadings = readings;
        document.getElementById('station-info').innerHTML = `<h4>${station.name}</h4><p>${station.location_description || 'Aucune description'}</p>`;
        document.getElementById('current-stats').style.display = 'grid';
        document.getElementById('export-btn').style.display = 'inline-flex';

        if (readings.length > 0) {
            const latest = readings[0];
            document.getElementById('val-iqa').innerText = latest.iqa;
            document.getElementById('val-pm25').innerText = latest.pm25.toFixed(1);
            document.getElementById('val-co').innerText = latest.co.toFixed(2);
            document.getElementById('val-temp').innerText = latest.temperature.toFixed(1);
            document.getElementById('val-hum').innerText = latest.humidity.toFixed(1);

            const iqaCard = document.getElementById('card-iqa');
            const iqaStatus = document.getElementById('iqa-status');
            const color = getIQAColor(latest.iqa);
            iqaCard.style.backgroundColor = color;
            iqaStatus.innerText = latest.iqa <= 50 ? "BON - Air sain" : (latest.iqa <= 100 ? "MODÉRÉ - Attention" : "MAUVAIS - Alerte");

            updateChart(readings.slice(0, 15).reverse());
        }
    }

    function updateChart(data) {
        const ctx = document.getElementById('airChart').getContext('2d');
        if (airChart) airChart.destroy();
        airChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(r => new Date(r.timestamp).toLocaleTimeString()),
                datasets: [{
                    label: 'IQA',
                    data: data.map(r => r.iqa),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16,185,129,0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    document.getElementById('export-btn').addEventListener('click', () => {
        if (!currentReadings.length) return;
        let csv = "Timestamp,IQA,PM2.5,CO,Temp,Humidity\n";
        currentReadings.forEach(r => {
            csv += `${r.timestamp},${r.iqa},${r.pm25},${r.co},${r.temperature},${r.humidity}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `readings_${new Date().getTime()}.csv`;
        a.click();
    });

    fetchStations();
</script>
{% endblock %}